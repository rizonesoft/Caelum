{"version":3,"file":"commands.js","mappings":"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","sources":["webpack://ai-email-writer/./src/features/settings.ts","webpack://ai-email-writer/./node_modules/@google/generative-ai/dist/index.mjs","webpack://ai-email-writer/./src/services/gemini.ts","webpack://ai-email-writer/webpack/bootstrap","webpack://ai-email-writer/webpack/runtime/define property getters","webpack://ai-email-writer/webpack/runtime/hasOwnProperty shorthand","webpack://ai-email-writer/webpack/runtime/make namespace object","webpack://ai-email-writer/./src/prompts/templates.ts","webpack://ai-email-writer/./src/commands/commands.ts","webpack://ai-email-writer/./src/prompts/builder.ts"],"sourcesContent":["/**\r\n * AI Compose — Settings Service\r\n *\r\n * Manages user preferences and API configuration.\r\n * Persists settings to localStorage (syncs automatically across sessions).\r\n *\r\n * © Rizonetech (Pty) Ltd. — https://rizonesoft.com\r\n */\r\n\r\nimport { initGeminiClient } from \"../services/gemini\";\r\n\r\n// ---------------------------------------------------------------------------\r\n// Types\r\n// ---------------------------------------------------------------------------\r\n\r\n/** Tone options available across Draft and Reply features. */\r\nexport type Tone = \"professional\" | \"formal\" | \"friendly\" | \"casual\";\r\n\r\n/** Summary style options for the Summarize feature. */\r\nexport type SummaryStyle = \"bullets\" | \"paragraph\" | \"tldr\";\r\n\r\n/** All persisted user preferences. */\r\nexport interface AIComposeSettings {\r\n  /** Google Gemini API key (stored in plain text in localStorage). */\r\n  apiKey: string;\r\n  /** Gemini model to use for all features. */\r\n  defaultModel: string;\r\n  /** Default tone for Draft Email and Reply. */\r\n  defaultTone: Tone;\r\n  /** Default summary style for Summarize. */\r\n  defaultSummaryStyle: SummaryStyle;\r\n  /** Default target language for Translate. */\r\n  defaultLanguage: string;\r\n  /** Preset rules toggled on/off by the user. */\r\n  presetRules: Record<string, boolean>;\r\n  /** Free-text custom rules supplied by the user. */\r\n  customRules: string;\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Defaults\r\n// ---------------------------------------------------------------------------\r\n\r\nconst STORAGE_KEY = \"ai_compose_settings\";\r\nconst LEGACY_STORAGE_KEY = \"glide_settings\";\r\n\r\nconst DEFAULT_SETTINGS: AIComposeSettings = {\r\n  apiKey: \"\",\r\n  defaultModel: \"gemini-3-flash-preview\",\r\n  defaultTone: \"professional\",\r\n  defaultSummaryStyle: \"bullets\",\r\n  defaultLanguage: \"English\",\r\n  presetRules: {\r\n    noPlaceholders: true,\r\n    noSubjectLine: false,\r\n    keepShort: false,\r\n    useSimpleLanguage: false,\r\n  },\r\n  customRules: \"\",\r\n};\r\n\r\n// ---------------------------------------------------------------------------\r\n// In-memory cache\r\n// ---------------------------------------------------------------------------\r\n\r\nlet cached: AIComposeSettings | null = null;\r\n\r\n// ---------------------------------------------------------------------------\r\n// Public API\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Load settings from localStorage (or return defaults).\r\n */\r\nexport function loadSettings(): AIComposeSettings {\r\n  if (cached) return { ...cached };\r\n\r\n  try {\r\n    let raw = localStorage.getItem(STORAGE_KEY);\r\n\r\n    // One-time migration from legacy \"glide_settings\" key\r\n    if (!raw) {\r\n      const legacy = localStorage.getItem(LEGACY_STORAGE_KEY);\r\n      if (legacy) {\r\n        raw = legacy;\r\n        localStorage.setItem(STORAGE_KEY, legacy);\r\n        localStorage.removeItem(LEGACY_STORAGE_KEY);\r\n      }\r\n    }\r\n\r\n    if (raw) {\r\n      const parsed = JSON.parse(raw) as Partial<AIComposeSettings>;\r\n      cached = { ...DEFAULT_SETTINGS, ...parsed };\r\n    } else {\r\n      cached = { ...DEFAULT_SETTINGS };\r\n    }\r\n  } catch {\r\n    cached = { ...DEFAULT_SETTINGS };\r\n  }\r\n\r\n  return { ...cached };\r\n}\r\n\r\n/**\r\n * Save settings to localStorage and update the in-memory cache.\r\n * If the API key changed, automatically re-initializes the Gemini client.\r\n */\r\nexport function saveSettings(settings: AIComposeSettings): void {\r\n  const previousKey = cached?.apiKey || \"\";\r\n\r\n  cached = { ...settings };\r\n\r\n  try {\r\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(cached));\r\n  } catch {\r\n    // localStorage might be unavailable in some sandboxed environments\r\n  }\r\n\r\n  // Re-initialize Gemini client if the API key changed\r\n  if (settings.apiKey && settings.apiKey !== previousKey) {\r\n    try {\r\n      initGeminiClient(settings.apiKey);\r\n    } catch {\r\n      // Will be retried on next action\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Get the current API key (loads settings if not cached).\r\n */\r\nexport function getApiKey(): string {\r\n  return loadSettings().apiKey;\r\n}\r\n\r\n/**\r\n * Update just the API key (convenience method).\r\n */\r\nexport function setApiKey(key: string): void {\r\n  const settings = loadSettings();\r\n  settings.apiKey = key;\r\n  saveSettings(settings);\r\n}\r\n\r\n/**\r\n * Get a single setting value.\r\n */\r\nexport function getSetting<K extends keyof AIComposeSettings>(key: K): AIComposeSettings[K] {\r\n  return loadSettings()[key];\r\n}\r\n\r\n/**\r\n * Reset all settings to defaults and clear localStorage.\r\n */\r\nexport function resetSettings(): void {\r\n  cached = { ...DEFAULT_SETTINGS };\r\n  try {\r\n    localStorage.removeItem(STORAGE_KEY);\r\n  } catch {\r\n    // Ignore\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Rules helpers\r\n// ---------------------------------------------------------------------------\r\n\r\n/** Human-readable labels for each preset rule. */\r\nconst PRESET_RULE_LABELS: Record<string, string> = {\r\n  noPlaceholders:\r\n    'Do not include placeholder tokens like [Your Name], [Company], or [Recipient]. Use real names from context or omit the sign-off entirely instead of using placeholders',\r\n  noSubjectLine:\r\n    \"Do not include a subject line in the output\",\r\n  keepShort:\r\n    \"Keep the output concise — no more than 5 sentences\",\r\n  useSimpleLanguage:\r\n    \"Use simple, easy-to-understand language (avoid jargon)\",\r\n};\r\n\r\nexport { PRESET_RULE_LABELS };\r\n\r\n/**\r\n * Build a combined rules string from preset + custom rules.\r\n * Returns an empty string if no rules are active.\r\n */\r\nexport function buildRulesText(): string {\r\n  const settings = loadSettings();\r\n  const lines: string[] = [];\r\n\r\n  for (const [key, enabled] of Object.entries(settings.presetRules)) {\r\n    if (enabled && PRESET_RULE_LABELS[key]) {\r\n      lines.push(`- ${PRESET_RULE_LABELS[key]}`);\r\n    }\r\n  }\r\n\r\n  if (settings.customRules.trim()) {\r\n    lines.push(`- ${settings.customRules.trim()}`);\r\n  }\r\n\r\n  return lines.length > 0 ? `\\n\\nAdditional rules:\\n${lines.join(\"\\n\")}` : \"\";\r\n}\r\n","/**\n * Contains the list of OpenAPI data types\n * as defined by https://swagger.io/docs/specification/data-models/data-types/\n * @public\n */\nvar SchemaType;\n(function (SchemaType) {\n    /** String type. */\n    SchemaType[\"STRING\"] = \"string\";\n    /** Number type. */\n    SchemaType[\"NUMBER\"] = \"number\";\n    /** Integer type. */\n    SchemaType[\"INTEGER\"] = \"integer\";\n    /** Boolean type. */\n    SchemaType[\"BOOLEAN\"] = \"boolean\";\n    /** Array type. */\n    SchemaType[\"ARRAY\"] = \"array\";\n    /** Object type. */\n    SchemaType[\"OBJECT\"] = \"object\";\n})(SchemaType || (SchemaType = {}));\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * @public\n */\nvar ExecutableCodeLanguage;\n(function (ExecutableCodeLanguage) {\n    ExecutableCodeLanguage[\"LANGUAGE_UNSPECIFIED\"] = \"language_unspecified\";\n    ExecutableCodeLanguage[\"PYTHON\"] = \"python\";\n})(ExecutableCodeLanguage || (ExecutableCodeLanguage = {}));\n/**\n * Possible outcomes of code execution.\n * @public\n */\nvar Outcome;\n(function (Outcome) {\n    /**\n     * Unspecified status. This value should not be used.\n     */\n    Outcome[\"OUTCOME_UNSPECIFIED\"] = \"outcome_unspecified\";\n    /**\n     * Code execution completed successfully.\n     */\n    Outcome[\"OUTCOME_OK\"] = \"outcome_ok\";\n    /**\n     * Code execution finished but with a failure. `stderr` should contain the\n     * reason.\n     */\n    Outcome[\"OUTCOME_FAILED\"] = \"outcome_failed\";\n    /**\n     * Code execution ran for too long, and was cancelled. There may or may not\n     * be a partial output present.\n     */\n    Outcome[\"OUTCOME_DEADLINE_EXCEEDED\"] = \"outcome_deadline_exceeded\";\n})(Outcome || (Outcome = {}));\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * Possible roles.\n * @public\n */\nconst POSSIBLE_ROLES = [\"user\", \"model\", \"function\", \"system\"];\n/**\n * Harm categories that would cause prompts or candidates to be blocked.\n * @public\n */\nvar HarmCategory;\n(function (HarmCategory) {\n    HarmCategory[\"HARM_CATEGORY_UNSPECIFIED\"] = \"HARM_CATEGORY_UNSPECIFIED\";\n    HarmCategory[\"HARM_CATEGORY_HATE_SPEECH\"] = \"HARM_CATEGORY_HATE_SPEECH\";\n    HarmCategory[\"HARM_CATEGORY_SEXUALLY_EXPLICIT\"] = \"HARM_CATEGORY_SEXUALLY_EXPLICIT\";\n    HarmCategory[\"HARM_CATEGORY_HARASSMENT\"] = \"HARM_CATEGORY_HARASSMENT\";\n    HarmCategory[\"HARM_CATEGORY_DANGEROUS_CONTENT\"] = \"HARM_CATEGORY_DANGEROUS_CONTENT\";\n    HarmCategory[\"HARM_CATEGORY_CIVIC_INTEGRITY\"] = \"HARM_CATEGORY_CIVIC_INTEGRITY\";\n})(HarmCategory || (HarmCategory = {}));\n/**\n * Threshold above which a prompt or candidate will be blocked.\n * @public\n */\nvar HarmBlockThreshold;\n(function (HarmBlockThreshold) {\n    /** Threshold is unspecified. */\n    HarmBlockThreshold[\"HARM_BLOCK_THRESHOLD_UNSPECIFIED\"] = \"HARM_BLOCK_THRESHOLD_UNSPECIFIED\";\n    /** Content with NEGLIGIBLE will be allowed. */\n    HarmBlockThreshold[\"BLOCK_LOW_AND_ABOVE\"] = \"BLOCK_LOW_AND_ABOVE\";\n    /** Content with NEGLIGIBLE and LOW will be allowed. */\n    HarmBlockThreshold[\"BLOCK_MEDIUM_AND_ABOVE\"] = \"BLOCK_MEDIUM_AND_ABOVE\";\n    /** Content with NEGLIGIBLE, LOW, and MEDIUM will be allowed. */\n    HarmBlockThreshold[\"BLOCK_ONLY_HIGH\"] = \"BLOCK_ONLY_HIGH\";\n    /** All content will be allowed. */\n    HarmBlockThreshold[\"BLOCK_NONE\"] = \"BLOCK_NONE\";\n})(HarmBlockThreshold || (HarmBlockThreshold = {}));\n/**\n * Probability that a prompt or candidate matches a harm category.\n * @public\n */\nvar HarmProbability;\n(function (HarmProbability) {\n    /** Probability is unspecified. */\n    HarmProbability[\"HARM_PROBABILITY_UNSPECIFIED\"] = \"HARM_PROBABILITY_UNSPECIFIED\";\n    /** Content has a negligible chance of being unsafe. */\n    HarmProbability[\"NEGLIGIBLE\"] = \"NEGLIGIBLE\";\n    /** Content has a low chance of being unsafe. */\n    HarmProbability[\"LOW\"] = \"LOW\";\n    /** Content has a medium chance of being unsafe. */\n    HarmProbability[\"MEDIUM\"] = \"MEDIUM\";\n    /** Content has a high chance of being unsafe. */\n    HarmProbability[\"HIGH\"] = \"HIGH\";\n})(HarmProbability || (HarmProbability = {}));\n/**\n * Reason that a prompt was blocked.\n * @public\n */\nvar BlockReason;\n(function (BlockReason) {\n    // A blocked reason was not specified.\n    BlockReason[\"BLOCKED_REASON_UNSPECIFIED\"] = \"BLOCKED_REASON_UNSPECIFIED\";\n    // Content was blocked by safety settings.\n    BlockReason[\"SAFETY\"] = \"SAFETY\";\n    // Content was blocked, but the reason is uncategorized.\n    BlockReason[\"OTHER\"] = \"OTHER\";\n})(BlockReason || (BlockReason = {}));\n/**\n * Reason that a candidate finished.\n * @public\n */\nvar FinishReason;\n(function (FinishReason) {\n    // Default value. This value is unused.\n    FinishReason[\"FINISH_REASON_UNSPECIFIED\"] = \"FINISH_REASON_UNSPECIFIED\";\n    // Natural stop point of the model or provided stop sequence.\n    FinishReason[\"STOP\"] = \"STOP\";\n    // The maximum number of tokens as specified in the request was reached.\n    FinishReason[\"MAX_TOKENS\"] = \"MAX_TOKENS\";\n    // The candidate content was flagged for safety reasons.\n    FinishReason[\"SAFETY\"] = \"SAFETY\";\n    // The candidate content was flagged for recitation reasons.\n    FinishReason[\"RECITATION\"] = \"RECITATION\";\n    // The candidate content was flagged for using an unsupported language.\n    FinishReason[\"LANGUAGE\"] = \"LANGUAGE\";\n    // Token generation stopped because the content contains forbidden terms.\n    FinishReason[\"BLOCKLIST\"] = \"BLOCKLIST\";\n    // Token generation stopped for potentially containing prohibited content.\n    FinishReason[\"PROHIBITED_CONTENT\"] = \"PROHIBITED_CONTENT\";\n    // Token generation stopped because the content potentially contains Sensitive Personally Identifiable Information (SPII).\n    FinishReason[\"SPII\"] = \"SPII\";\n    // The function call generated by the model is invalid.\n    FinishReason[\"MALFORMED_FUNCTION_CALL\"] = \"MALFORMED_FUNCTION_CALL\";\n    // Unknown reason.\n    FinishReason[\"OTHER\"] = \"OTHER\";\n})(FinishReason || (FinishReason = {}));\n/**\n * Task type for embedding content.\n * @public\n */\nvar TaskType;\n(function (TaskType) {\n    TaskType[\"TASK_TYPE_UNSPECIFIED\"] = \"TASK_TYPE_UNSPECIFIED\";\n    TaskType[\"RETRIEVAL_QUERY\"] = \"RETRIEVAL_QUERY\";\n    TaskType[\"RETRIEVAL_DOCUMENT\"] = \"RETRIEVAL_DOCUMENT\";\n    TaskType[\"SEMANTIC_SIMILARITY\"] = \"SEMANTIC_SIMILARITY\";\n    TaskType[\"CLASSIFICATION\"] = \"CLASSIFICATION\";\n    TaskType[\"CLUSTERING\"] = \"CLUSTERING\";\n})(TaskType || (TaskType = {}));\n/**\n * @public\n */\nvar FunctionCallingMode;\n(function (FunctionCallingMode) {\n    // Unspecified function calling mode. This value should not be used.\n    FunctionCallingMode[\"MODE_UNSPECIFIED\"] = \"MODE_UNSPECIFIED\";\n    // Default model behavior, model decides to predict either a function call\n    // or a natural language repspose.\n    FunctionCallingMode[\"AUTO\"] = \"AUTO\";\n    // Model is constrained to always predicting a function call only.\n    // If \"allowed_function_names\" are set, the predicted function call will be\n    // limited to any one of \"allowed_function_names\", else the predicted\n    // function call will be any one of the provided \"function_declarations\".\n    FunctionCallingMode[\"ANY\"] = \"ANY\";\n    // Model will not predict any function call. Model behavior is same as when\n    // not passing any function declarations.\n    FunctionCallingMode[\"NONE\"] = \"NONE\";\n})(FunctionCallingMode || (FunctionCallingMode = {}));\n/**\n * The mode of the predictor to be used in dynamic retrieval.\n * @public\n */\nvar DynamicRetrievalMode;\n(function (DynamicRetrievalMode) {\n    // Unspecified function calling mode. This value should not be used.\n    DynamicRetrievalMode[\"MODE_UNSPECIFIED\"] = \"MODE_UNSPECIFIED\";\n    // Run retrieval only when system decides it is necessary.\n    DynamicRetrievalMode[\"MODE_DYNAMIC\"] = \"MODE_DYNAMIC\";\n})(DynamicRetrievalMode || (DynamicRetrievalMode = {}));\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * Basic error type for this SDK.\n * @public\n */\nclass GoogleGenerativeAIError extends Error {\n    constructor(message) {\n        super(`[GoogleGenerativeAI Error]: ${message}`);\n    }\n}\n/**\n * Errors in the contents of a response from the model. This includes parsing\n * errors, or responses including a safety block reason.\n * @public\n */\nclass GoogleGenerativeAIResponseError extends GoogleGenerativeAIError {\n    constructor(message, response) {\n        super(message);\n        this.response = response;\n    }\n}\n/**\n * Error class covering HTTP errors when calling the server. Includes HTTP\n * status, statusText, and optional details, if provided in the server response.\n * @public\n */\nclass GoogleGenerativeAIFetchError extends GoogleGenerativeAIError {\n    constructor(message, status, statusText, errorDetails) {\n        super(message);\n        this.status = status;\n        this.statusText = statusText;\n        this.errorDetails = errorDetails;\n    }\n}\n/**\n * Errors in the contents of a request originating from user input.\n * @public\n */\nclass GoogleGenerativeAIRequestInputError extends GoogleGenerativeAIError {\n}\n/**\n * Error thrown when a request is aborted, either due to a timeout or\n * intentional cancellation by the user.\n * @public\n */\nclass GoogleGenerativeAIAbortError extends GoogleGenerativeAIError {\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nconst DEFAULT_BASE_URL = \"https://generativelanguage.googleapis.com\";\nconst DEFAULT_API_VERSION = \"v1beta\";\n/**\n * We can't `require` package.json if this runs on web. We will use rollup to\n * swap in the version number here at build time.\n */\nconst PACKAGE_VERSION = \"0.24.1\";\nconst PACKAGE_LOG_HEADER = \"genai-js\";\nvar Task;\n(function (Task) {\n    Task[\"GENERATE_CONTENT\"] = \"generateContent\";\n    Task[\"STREAM_GENERATE_CONTENT\"] = \"streamGenerateContent\";\n    Task[\"COUNT_TOKENS\"] = \"countTokens\";\n    Task[\"EMBED_CONTENT\"] = \"embedContent\";\n    Task[\"BATCH_EMBED_CONTENTS\"] = \"batchEmbedContents\";\n})(Task || (Task = {}));\nclass RequestUrl {\n    constructor(model, task, apiKey, stream, requestOptions) {\n        this.model = model;\n        this.task = task;\n        this.apiKey = apiKey;\n        this.stream = stream;\n        this.requestOptions = requestOptions;\n    }\n    toString() {\n        var _a, _b;\n        const apiVersion = ((_a = this.requestOptions) === null || _a === void 0 ? void 0 : _a.apiVersion) || DEFAULT_API_VERSION;\n        const baseUrl = ((_b = this.requestOptions) === null || _b === void 0 ? void 0 : _b.baseUrl) || DEFAULT_BASE_URL;\n        let url = `${baseUrl}/${apiVersion}/${this.model}:${this.task}`;\n        if (this.stream) {\n            url += \"?alt=sse\";\n        }\n        return url;\n    }\n}\n/**\n * Simple, but may become more complex if we add more versions to log.\n */\nfunction getClientHeaders(requestOptions) {\n    const clientHeaders = [];\n    if (requestOptions === null || requestOptions === void 0 ? void 0 : requestOptions.apiClient) {\n        clientHeaders.push(requestOptions.apiClient);\n    }\n    clientHeaders.push(`${PACKAGE_LOG_HEADER}/${PACKAGE_VERSION}`);\n    return clientHeaders.join(\" \");\n}\nasync function getHeaders(url) {\n    var _a;\n    const headers = new Headers();\n    headers.append(\"Content-Type\", \"application/json\");\n    headers.append(\"x-goog-api-client\", getClientHeaders(url.requestOptions));\n    headers.append(\"x-goog-api-key\", url.apiKey);\n    let customHeaders = (_a = url.requestOptions) === null || _a === void 0 ? void 0 : _a.customHeaders;\n    if (customHeaders) {\n        if (!(customHeaders instanceof Headers)) {\n            try {\n                customHeaders = new Headers(customHeaders);\n            }\n            catch (e) {\n                throw new GoogleGenerativeAIRequestInputError(`unable to convert customHeaders value ${JSON.stringify(customHeaders)} to Headers: ${e.message}`);\n            }\n        }\n        for (const [headerName, headerValue] of customHeaders.entries()) {\n            if (headerName === \"x-goog-api-key\") {\n                throw new GoogleGenerativeAIRequestInputError(`Cannot set reserved header name ${headerName}`);\n            }\n            else if (headerName === \"x-goog-api-client\") {\n                throw new GoogleGenerativeAIRequestInputError(`Header name ${headerName} can only be set using the apiClient field`);\n            }\n            headers.append(headerName, headerValue);\n        }\n    }\n    return headers;\n}\nasync function constructModelRequest(model, task, apiKey, stream, body, requestOptions) {\n    const url = new RequestUrl(model, task, apiKey, stream, requestOptions);\n    return {\n        url: url.toString(),\n        fetchOptions: Object.assign(Object.assign({}, buildFetchOptions(requestOptions)), { method: \"POST\", headers: await getHeaders(url), body }),\n    };\n}\nasync function makeModelRequest(model, task, apiKey, stream, body, requestOptions = {}, \n// Allows this to be stubbed for tests\nfetchFn = fetch) {\n    const { url, fetchOptions } = await constructModelRequest(model, task, apiKey, stream, body, requestOptions);\n    return makeRequest(url, fetchOptions, fetchFn);\n}\nasync function makeRequest(url, fetchOptions, fetchFn = fetch) {\n    let response;\n    try {\n        response = await fetchFn(url, fetchOptions);\n    }\n    catch (e) {\n        handleResponseError(e, url);\n    }\n    if (!response.ok) {\n        await handleResponseNotOk(response, url);\n    }\n    return response;\n}\nfunction handleResponseError(e, url) {\n    let err = e;\n    if (err.name === \"AbortError\") {\n        err = new GoogleGenerativeAIAbortError(`Request aborted when fetching ${url.toString()}: ${e.message}`);\n        err.stack = e.stack;\n    }\n    else if (!(e instanceof GoogleGenerativeAIFetchError ||\n        e instanceof GoogleGenerativeAIRequestInputError)) {\n        err = new GoogleGenerativeAIError(`Error fetching from ${url.toString()}: ${e.message}`);\n        err.stack = e.stack;\n    }\n    throw err;\n}\nasync function handleResponseNotOk(response, url) {\n    let message = \"\";\n    let errorDetails;\n    try {\n        const json = await response.json();\n        message = json.error.message;\n        if (json.error.details) {\n            message += ` ${JSON.stringify(json.error.details)}`;\n            errorDetails = json.error.details;\n        }\n    }\n    catch (e) {\n        // ignored\n    }\n    throw new GoogleGenerativeAIFetchError(`Error fetching from ${url.toString()}: [${response.status} ${response.statusText}] ${message}`, response.status, response.statusText, errorDetails);\n}\n/**\n * Generates the request options to be passed to the fetch API.\n * @param requestOptions - The user-defined request options.\n * @returns The generated request options.\n */\nfunction buildFetchOptions(requestOptions) {\n    const fetchOptions = {};\n    if ((requestOptions === null || requestOptions === void 0 ? void 0 : requestOptions.signal) !== undefined || (requestOptions === null || requestOptions === void 0 ? void 0 : requestOptions.timeout) >= 0) {\n        const controller = new AbortController();\n        if ((requestOptions === null || requestOptions === void 0 ? void 0 : requestOptions.timeout) >= 0) {\n            setTimeout(() => controller.abort(), requestOptions.timeout);\n        }\n        if (requestOptions === null || requestOptions === void 0 ? void 0 : requestOptions.signal) {\n            requestOptions.signal.addEventListener(\"abort\", () => {\n                controller.abort();\n            });\n        }\n        fetchOptions.signal = controller.signal;\n    }\n    return fetchOptions;\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * Adds convenience helper methods to a response object, including stream\n * chunks (as long as each chunk is a complete GenerateContentResponse JSON).\n */\nfunction addHelpers(response) {\n    response.text = () => {\n        if (response.candidates && response.candidates.length > 0) {\n            if (response.candidates.length > 1) {\n                console.warn(`This response had ${response.candidates.length} ` +\n                    `candidates. Returning text from the first candidate only. ` +\n                    `Access response.candidates directly to use the other candidates.`);\n            }\n            if (hadBadFinishReason(response.candidates[0])) {\n                throw new GoogleGenerativeAIResponseError(`${formatBlockErrorMessage(response)}`, response);\n            }\n            return getText(response);\n        }\n        else if (response.promptFeedback) {\n            throw new GoogleGenerativeAIResponseError(`Text not available. ${formatBlockErrorMessage(response)}`, response);\n        }\n        return \"\";\n    };\n    /**\n     * TODO: remove at next major version\n     */\n    response.functionCall = () => {\n        if (response.candidates && response.candidates.length > 0) {\n            if (response.candidates.length > 1) {\n                console.warn(`This response had ${response.candidates.length} ` +\n                    `candidates. Returning function calls from the first candidate only. ` +\n                    `Access response.candidates directly to use the other candidates.`);\n            }\n            if (hadBadFinishReason(response.candidates[0])) {\n                throw new GoogleGenerativeAIResponseError(`${formatBlockErrorMessage(response)}`, response);\n            }\n            console.warn(`response.functionCall() is deprecated. ` +\n                `Use response.functionCalls() instead.`);\n            return getFunctionCalls(response)[0];\n        }\n        else if (response.promptFeedback) {\n            throw new GoogleGenerativeAIResponseError(`Function call not available. ${formatBlockErrorMessage(response)}`, response);\n        }\n        return undefined;\n    };\n    response.functionCalls = () => {\n        if (response.candidates && response.candidates.length > 0) {\n            if (response.candidates.length > 1) {\n                console.warn(`This response had ${response.candidates.length} ` +\n                    `candidates. Returning function calls from the first candidate only. ` +\n                    `Access response.candidates directly to use the other candidates.`);\n            }\n            if (hadBadFinishReason(response.candidates[0])) {\n                throw new GoogleGenerativeAIResponseError(`${formatBlockErrorMessage(response)}`, response);\n            }\n            return getFunctionCalls(response);\n        }\n        else if (response.promptFeedback) {\n            throw new GoogleGenerativeAIResponseError(`Function call not available. ${formatBlockErrorMessage(response)}`, response);\n        }\n        return undefined;\n    };\n    return response;\n}\n/**\n * Returns all text found in all parts of first candidate.\n */\nfunction getText(response) {\n    var _a, _b, _c, _d;\n    const textStrings = [];\n    if ((_b = (_a = response.candidates) === null || _a === void 0 ? void 0 : _a[0].content) === null || _b === void 0 ? void 0 : _b.parts) {\n        for (const part of (_d = (_c = response.candidates) === null || _c === void 0 ? void 0 : _c[0].content) === null || _d === void 0 ? void 0 : _d.parts) {\n            if (part.text) {\n                textStrings.push(part.text);\n            }\n            if (part.executableCode) {\n                textStrings.push(\"\\n```\" +\n                    part.executableCode.language +\n                    \"\\n\" +\n                    part.executableCode.code +\n                    \"\\n```\\n\");\n            }\n            if (part.codeExecutionResult) {\n                textStrings.push(\"\\n```\\n\" + part.codeExecutionResult.output + \"\\n```\\n\");\n            }\n        }\n    }\n    if (textStrings.length > 0) {\n        return textStrings.join(\"\");\n    }\n    else {\n        return \"\";\n    }\n}\n/**\n * Returns functionCall of first candidate.\n */\nfunction getFunctionCalls(response) {\n    var _a, _b, _c, _d;\n    const functionCalls = [];\n    if ((_b = (_a = response.candidates) === null || _a === void 0 ? void 0 : _a[0].content) === null || _b === void 0 ? void 0 : _b.parts) {\n        for (const part of (_d = (_c = response.candidates) === null || _c === void 0 ? void 0 : _c[0].content) === null || _d === void 0 ? void 0 : _d.parts) {\n            if (part.functionCall) {\n                functionCalls.push(part.functionCall);\n            }\n        }\n    }\n    if (functionCalls.length > 0) {\n        return functionCalls;\n    }\n    else {\n        return undefined;\n    }\n}\nconst badFinishReasons = [\n    FinishReason.RECITATION,\n    FinishReason.SAFETY,\n    FinishReason.LANGUAGE,\n];\nfunction hadBadFinishReason(candidate) {\n    return (!!candidate.finishReason &&\n        badFinishReasons.includes(candidate.finishReason));\n}\nfunction formatBlockErrorMessage(response) {\n    var _a, _b, _c;\n    let message = \"\";\n    if ((!response.candidates || response.candidates.length === 0) &&\n        response.promptFeedback) {\n        message += \"Response was blocked\";\n        if ((_a = response.promptFeedback) === null || _a === void 0 ? void 0 : _a.blockReason) {\n            message += ` due to ${response.promptFeedback.blockReason}`;\n        }\n        if ((_b = response.promptFeedback) === null || _b === void 0 ? void 0 : _b.blockReasonMessage) {\n            message += `: ${response.promptFeedback.blockReasonMessage}`;\n        }\n    }\n    else if ((_c = response.candidates) === null || _c === void 0 ? void 0 : _c[0]) {\n        const firstCandidate = response.candidates[0];\n        if (hadBadFinishReason(firstCandidate)) {\n            message += `Candidate was blocked due to ${firstCandidate.finishReason}`;\n            if (firstCandidate.finishMessage) {\n                message += `: ${firstCandidate.finishMessage}`;\n            }\n        }\n    }\n    return message;\n}\n\n/******************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise, SuppressedError, Symbol */\r\n\r\n\r\nfunction __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nfunction __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\ntypeof SuppressedError === \"function\" ? SuppressedError : function (error, suppressed, message) {\r\n    var e = new Error(message);\r\n    return e.name = \"SuppressedError\", e.error = error, e.suppressed = suppressed, e;\r\n};\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nconst responseLineRE = /^data\\: (.*)(?:\\n\\n|\\r\\r|\\r\\n\\r\\n)/;\n/**\n * Process a response.body stream from the backend and return an\n * iterator that provides one complete GenerateContentResponse at a time\n * and a promise that resolves with a single aggregated\n * GenerateContentResponse.\n *\n * @param response - Response from a fetch call\n */\nfunction processStream(response) {\n    const inputStream = response.body.pipeThrough(new TextDecoderStream(\"utf8\", { fatal: true }));\n    const responseStream = getResponseStream(inputStream);\n    const [stream1, stream2] = responseStream.tee();\n    return {\n        stream: generateResponseSequence(stream1),\n        response: getResponsePromise(stream2),\n    };\n}\nasync function getResponsePromise(stream) {\n    const allResponses = [];\n    const reader = stream.getReader();\n    while (true) {\n        const { done, value } = await reader.read();\n        if (done) {\n            return addHelpers(aggregateResponses(allResponses));\n        }\n        allResponses.push(value);\n    }\n}\nfunction generateResponseSequence(stream) {\n    return __asyncGenerator(this, arguments, function* generateResponseSequence_1() {\n        const reader = stream.getReader();\n        while (true) {\n            const { value, done } = yield __await(reader.read());\n            if (done) {\n                break;\n            }\n            yield yield __await(addHelpers(value));\n        }\n    });\n}\n/**\n * Reads a raw stream from the fetch response and join incomplete\n * chunks, returning a new stream that provides a single complete\n * GenerateContentResponse in each iteration.\n */\nfunction getResponseStream(inputStream) {\n    const reader = inputStream.getReader();\n    const stream = new ReadableStream({\n        start(controller) {\n            let currentText = \"\";\n            return pump();\n            function pump() {\n                return reader\n                    .read()\n                    .then(({ value, done }) => {\n                    if (done) {\n                        if (currentText.trim()) {\n                            controller.error(new GoogleGenerativeAIError(\"Failed to parse stream\"));\n                            return;\n                        }\n                        controller.close();\n                        return;\n                    }\n                    currentText += value;\n                    let match = currentText.match(responseLineRE);\n                    let parsedResponse;\n                    while (match) {\n                        try {\n                            parsedResponse = JSON.parse(match[1]);\n                        }\n                        catch (e) {\n                            controller.error(new GoogleGenerativeAIError(`Error parsing JSON response: \"${match[1]}\"`));\n                            return;\n                        }\n                        controller.enqueue(parsedResponse);\n                        currentText = currentText.substring(match[0].length);\n                        match = currentText.match(responseLineRE);\n                    }\n                    return pump();\n                })\n                    .catch((e) => {\n                    let err = e;\n                    err.stack = e.stack;\n                    if (err.name === \"AbortError\") {\n                        err = new GoogleGenerativeAIAbortError(\"Request aborted when reading from the stream\");\n                    }\n                    else {\n                        err = new GoogleGenerativeAIError(\"Error reading from the stream\");\n                    }\n                    throw err;\n                });\n            }\n        },\n    });\n    return stream;\n}\n/**\n * Aggregates an array of `GenerateContentResponse`s into a single\n * GenerateContentResponse.\n */\nfunction aggregateResponses(responses) {\n    const lastResponse = responses[responses.length - 1];\n    const aggregatedResponse = {\n        promptFeedback: lastResponse === null || lastResponse === void 0 ? void 0 : lastResponse.promptFeedback,\n    };\n    for (const response of responses) {\n        if (response.candidates) {\n            let candidateIndex = 0;\n            for (const candidate of response.candidates) {\n                if (!aggregatedResponse.candidates) {\n                    aggregatedResponse.candidates = [];\n                }\n                if (!aggregatedResponse.candidates[candidateIndex]) {\n                    aggregatedResponse.candidates[candidateIndex] = {\n                        index: candidateIndex,\n                    };\n                }\n                // Keep overwriting, the last one will be final\n                aggregatedResponse.candidates[candidateIndex].citationMetadata =\n                    candidate.citationMetadata;\n                aggregatedResponse.candidates[candidateIndex].groundingMetadata =\n                    candidate.groundingMetadata;\n                aggregatedResponse.candidates[candidateIndex].finishReason =\n                    candidate.finishReason;\n                aggregatedResponse.candidates[candidateIndex].finishMessage =\n                    candidate.finishMessage;\n                aggregatedResponse.candidates[candidateIndex].safetyRatings =\n                    candidate.safetyRatings;\n                /**\n                 * Candidates should always have content and parts, but this handles\n                 * possible malformed responses.\n                 */\n                if (candidate.content && candidate.content.parts) {\n                    if (!aggregatedResponse.candidates[candidateIndex].content) {\n                        aggregatedResponse.candidates[candidateIndex].content = {\n                            role: candidate.content.role || \"user\",\n                            parts: [],\n                        };\n                    }\n                    const newPart = {};\n                    for (const part of candidate.content.parts) {\n                        if (part.text) {\n                            newPart.text = part.text;\n                        }\n                        if (part.functionCall) {\n                            newPart.functionCall = part.functionCall;\n                        }\n                        if (part.executableCode) {\n                            newPart.executableCode = part.executableCode;\n                        }\n                        if (part.codeExecutionResult) {\n                            newPart.codeExecutionResult = part.codeExecutionResult;\n                        }\n                        if (Object.keys(newPart).length === 0) {\n                            newPart.text = \"\";\n                        }\n                        aggregatedResponse.candidates[candidateIndex].content.parts.push(newPart);\n                    }\n                }\n            }\n            candidateIndex++;\n        }\n        if (response.usageMetadata) {\n            aggregatedResponse.usageMetadata = response.usageMetadata;\n        }\n    }\n    return aggregatedResponse;\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nasync function generateContentStream(apiKey, model, params, requestOptions) {\n    const response = await makeModelRequest(model, Task.STREAM_GENERATE_CONTENT, apiKey, \n    /* stream */ true, JSON.stringify(params), requestOptions);\n    return processStream(response);\n}\nasync function generateContent(apiKey, model, params, requestOptions) {\n    const response = await makeModelRequest(model, Task.GENERATE_CONTENT, apiKey, \n    /* stream */ false, JSON.stringify(params), requestOptions);\n    const responseJson = await response.json();\n    const enhancedResponse = addHelpers(responseJson);\n    return {\n        response: enhancedResponse,\n    };\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nfunction formatSystemInstruction(input) {\n    // null or undefined\n    if (input == null) {\n        return undefined;\n    }\n    else if (typeof input === \"string\") {\n        return { role: \"system\", parts: [{ text: input }] };\n    }\n    else if (input.text) {\n        return { role: \"system\", parts: [input] };\n    }\n    else if (input.parts) {\n        if (!input.role) {\n            return { role: \"system\", parts: input.parts };\n        }\n        else {\n            return input;\n        }\n    }\n}\nfunction formatNewContent(request) {\n    let newParts = [];\n    if (typeof request === \"string\") {\n        newParts = [{ text: request }];\n    }\n    else {\n        for (const partOrString of request) {\n            if (typeof partOrString === \"string\") {\n                newParts.push({ text: partOrString });\n            }\n            else {\n                newParts.push(partOrString);\n            }\n        }\n    }\n    return assignRoleToPartsAndValidateSendMessageRequest(newParts);\n}\n/**\n * When multiple Part types (i.e. FunctionResponsePart and TextPart) are\n * passed in a single Part array, we may need to assign different roles to each\n * part. Currently only FunctionResponsePart requires a role other than 'user'.\n * @private\n * @param parts Array of parts to pass to the model\n * @returns Array of content items\n */\nfunction assignRoleToPartsAndValidateSendMessageRequest(parts) {\n    const userContent = { role: \"user\", parts: [] };\n    const functionContent = { role: \"function\", parts: [] };\n    let hasUserContent = false;\n    let hasFunctionContent = false;\n    for (const part of parts) {\n        if (\"functionResponse\" in part) {\n            functionContent.parts.push(part);\n            hasFunctionContent = true;\n        }\n        else {\n            userContent.parts.push(part);\n            hasUserContent = true;\n        }\n    }\n    if (hasUserContent && hasFunctionContent) {\n        throw new GoogleGenerativeAIError(\"Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.\");\n    }\n    if (!hasUserContent && !hasFunctionContent) {\n        throw new GoogleGenerativeAIError(\"No content is provided for sending chat message.\");\n    }\n    if (hasUserContent) {\n        return userContent;\n    }\n    return functionContent;\n}\nfunction formatCountTokensInput(params, modelParams) {\n    var _a;\n    let formattedGenerateContentRequest = {\n        model: modelParams === null || modelParams === void 0 ? void 0 : modelParams.model,\n        generationConfig: modelParams === null || modelParams === void 0 ? void 0 : modelParams.generationConfig,\n        safetySettings: modelParams === null || modelParams === void 0 ? void 0 : modelParams.safetySettings,\n        tools: modelParams === null || modelParams === void 0 ? void 0 : modelParams.tools,\n        toolConfig: modelParams === null || modelParams === void 0 ? void 0 : modelParams.toolConfig,\n        systemInstruction: modelParams === null || modelParams === void 0 ? void 0 : modelParams.systemInstruction,\n        cachedContent: (_a = modelParams === null || modelParams === void 0 ? void 0 : modelParams.cachedContent) === null || _a === void 0 ? void 0 : _a.name,\n        contents: [],\n    };\n    const containsGenerateContentRequest = params.generateContentRequest != null;\n    if (params.contents) {\n        if (containsGenerateContentRequest) {\n            throw new GoogleGenerativeAIRequestInputError(\"CountTokensRequest must have one of contents or generateContentRequest, not both.\");\n        }\n        formattedGenerateContentRequest.contents = params.contents;\n    }\n    else if (containsGenerateContentRequest) {\n        formattedGenerateContentRequest = Object.assign(Object.assign({}, formattedGenerateContentRequest), params.generateContentRequest);\n    }\n    else {\n        // Array or string\n        const content = formatNewContent(params);\n        formattedGenerateContentRequest.contents = [content];\n    }\n    return { generateContentRequest: formattedGenerateContentRequest };\n}\nfunction formatGenerateContentInput(params) {\n    let formattedRequest;\n    if (params.contents) {\n        formattedRequest = params;\n    }\n    else {\n        // Array or string\n        const content = formatNewContent(params);\n        formattedRequest = { contents: [content] };\n    }\n    if (params.systemInstruction) {\n        formattedRequest.systemInstruction = formatSystemInstruction(params.systemInstruction);\n    }\n    return formattedRequest;\n}\nfunction formatEmbedContentInput(params) {\n    if (typeof params === \"string\" || Array.isArray(params)) {\n        const content = formatNewContent(params);\n        return { content };\n    }\n    return params;\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n// https://ai.google.dev/api/rest/v1beta/Content#part\nconst VALID_PART_FIELDS = [\n    \"text\",\n    \"inlineData\",\n    \"functionCall\",\n    \"functionResponse\",\n    \"executableCode\",\n    \"codeExecutionResult\",\n];\nconst VALID_PARTS_PER_ROLE = {\n    user: [\"text\", \"inlineData\"],\n    function: [\"functionResponse\"],\n    model: [\"text\", \"functionCall\", \"executableCode\", \"codeExecutionResult\"],\n    // System instructions shouldn't be in history anyway.\n    system: [\"text\"],\n};\nfunction validateChatHistory(history) {\n    let prevContent = false;\n    for (const currContent of history) {\n        const { role, parts } = currContent;\n        if (!prevContent && role !== \"user\") {\n            throw new GoogleGenerativeAIError(`First content should be with role 'user', got ${role}`);\n        }\n        if (!POSSIBLE_ROLES.includes(role)) {\n            throw new GoogleGenerativeAIError(`Each item should include role field. Got ${role} but valid roles are: ${JSON.stringify(POSSIBLE_ROLES)}`);\n        }\n        if (!Array.isArray(parts)) {\n            throw new GoogleGenerativeAIError(\"Content should have 'parts' property with an array of Parts\");\n        }\n        if (parts.length === 0) {\n            throw new GoogleGenerativeAIError(\"Each Content should have at least one part\");\n        }\n        const countFields = {\n            text: 0,\n            inlineData: 0,\n            functionCall: 0,\n            functionResponse: 0,\n            fileData: 0,\n            executableCode: 0,\n            codeExecutionResult: 0,\n        };\n        for (const part of parts) {\n            for (const key of VALID_PART_FIELDS) {\n                if (key in part) {\n                    countFields[key] += 1;\n                }\n            }\n        }\n        const validParts = VALID_PARTS_PER_ROLE[role];\n        for (const key of VALID_PART_FIELDS) {\n            if (!validParts.includes(key) && countFields[key] > 0) {\n                throw new GoogleGenerativeAIError(`Content with role '${role}' can't contain '${key}' part`);\n            }\n        }\n        prevContent = true;\n    }\n}\n/**\n * Returns true if the response is valid (could be appended to the history), flase otherwise.\n */\nfunction isValidResponse(response) {\n    var _a;\n    if (response.candidates === undefined || response.candidates.length === 0) {\n        return false;\n    }\n    const content = (_a = response.candidates[0]) === null || _a === void 0 ? void 0 : _a.content;\n    if (content === undefined) {\n        return false;\n    }\n    if (content.parts === undefined || content.parts.length === 0) {\n        return false;\n    }\n    for (const part of content.parts) {\n        if (part === undefined || Object.keys(part).length === 0) {\n            return false;\n        }\n        if (part.text !== undefined && part.text === \"\") {\n            return false;\n        }\n    }\n    return true;\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * Do not log a message for this error.\n */\nconst SILENT_ERROR = \"SILENT_ERROR\";\n/**\n * ChatSession class that enables sending chat messages and stores\n * history of sent and received messages so far.\n *\n * @public\n */\nclass ChatSession {\n    constructor(apiKey, model, params, _requestOptions = {}) {\n        this.model = model;\n        this.params = params;\n        this._requestOptions = _requestOptions;\n        this._history = [];\n        this._sendPromise = Promise.resolve();\n        this._apiKey = apiKey;\n        if (params === null || params === void 0 ? void 0 : params.history) {\n            validateChatHistory(params.history);\n            this._history = params.history;\n        }\n    }\n    /**\n     * Gets the chat history so far. Blocked prompts are not added to history.\n     * Blocked candidates are not added to history, nor are the prompts that\n     * generated them.\n     */\n    async getHistory() {\n        await this._sendPromise;\n        return this._history;\n    }\n    /**\n     * Sends a chat message and receives a non-streaming\n     * {@link GenerateContentResult}.\n     *\n     * Fields set in the optional {@link SingleRequestOptions} parameter will\n     * take precedence over the {@link RequestOptions} values provided to\n     * {@link GoogleGenerativeAI.getGenerativeModel }.\n     */\n    async sendMessage(request, requestOptions = {}) {\n        var _a, _b, _c, _d, _e, _f;\n        await this._sendPromise;\n        const newContent = formatNewContent(request);\n        const generateContentRequest = {\n            safetySettings: (_a = this.params) === null || _a === void 0 ? void 0 : _a.safetySettings,\n            generationConfig: (_b = this.params) === null || _b === void 0 ? void 0 : _b.generationConfig,\n            tools: (_c = this.params) === null || _c === void 0 ? void 0 : _c.tools,\n            toolConfig: (_d = this.params) === null || _d === void 0 ? void 0 : _d.toolConfig,\n            systemInstruction: (_e = this.params) === null || _e === void 0 ? void 0 : _e.systemInstruction,\n            cachedContent: (_f = this.params) === null || _f === void 0 ? void 0 : _f.cachedContent,\n            contents: [...this._history, newContent],\n        };\n        const chatSessionRequestOptions = Object.assign(Object.assign({}, this._requestOptions), requestOptions);\n        let finalResult;\n        // Add onto the chain.\n        this._sendPromise = this._sendPromise\n            .then(() => generateContent(this._apiKey, this.model, generateContentRequest, chatSessionRequestOptions))\n            .then((result) => {\n            var _a;\n            if (isValidResponse(result.response)) {\n                this._history.push(newContent);\n                const responseContent = Object.assign({ parts: [], \n                    // Response seems to come back without a role set.\n                    role: \"model\" }, (_a = result.response.candidates) === null || _a === void 0 ? void 0 : _a[0].content);\n                this._history.push(responseContent);\n            }\n            else {\n                const blockErrorMessage = formatBlockErrorMessage(result.response);\n                if (blockErrorMessage) {\n                    console.warn(`sendMessage() was unsuccessful. ${blockErrorMessage}. Inspect response object for details.`);\n                }\n            }\n            finalResult = result;\n        })\n            .catch((e) => {\n            // Resets _sendPromise to avoid subsequent calls failing and throw error.\n            this._sendPromise = Promise.resolve();\n            throw e;\n        });\n        await this._sendPromise;\n        return finalResult;\n    }\n    /**\n     * Sends a chat message and receives the response as a\n     * {@link GenerateContentStreamResult} containing an iterable stream\n     * and a response promise.\n     *\n     * Fields set in the optional {@link SingleRequestOptions} parameter will\n     * take precedence over the {@link RequestOptions} values provided to\n     * {@link GoogleGenerativeAI.getGenerativeModel }.\n     */\n    async sendMessageStream(request, requestOptions = {}) {\n        var _a, _b, _c, _d, _e, _f;\n        await this._sendPromise;\n        const newContent = formatNewContent(request);\n        const generateContentRequest = {\n            safetySettings: (_a = this.params) === null || _a === void 0 ? void 0 : _a.safetySettings,\n            generationConfig: (_b = this.params) === null || _b === void 0 ? void 0 : _b.generationConfig,\n            tools: (_c = this.params) === null || _c === void 0 ? void 0 : _c.tools,\n            toolConfig: (_d = this.params) === null || _d === void 0 ? void 0 : _d.toolConfig,\n            systemInstruction: (_e = this.params) === null || _e === void 0 ? void 0 : _e.systemInstruction,\n            cachedContent: (_f = this.params) === null || _f === void 0 ? void 0 : _f.cachedContent,\n            contents: [...this._history, newContent],\n        };\n        const chatSessionRequestOptions = Object.assign(Object.assign({}, this._requestOptions), requestOptions);\n        const streamPromise = generateContentStream(this._apiKey, this.model, generateContentRequest, chatSessionRequestOptions);\n        // Add onto the chain.\n        this._sendPromise = this._sendPromise\n            .then(() => streamPromise)\n            // This must be handled to avoid unhandled rejection, but jump\n            // to the final catch block with a label to not log this error.\n            .catch((_ignored) => {\n            throw new Error(SILENT_ERROR);\n        })\n            .then((streamResult) => streamResult.response)\n            .then((response) => {\n            if (isValidResponse(response)) {\n                this._history.push(newContent);\n                const responseContent = Object.assign({}, response.candidates[0].content);\n                // Response seems to come back without a role set.\n                if (!responseContent.role) {\n                    responseContent.role = \"model\";\n                }\n                this._history.push(responseContent);\n            }\n            else {\n                const blockErrorMessage = formatBlockErrorMessage(response);\n                if (blockErrorMessage) {\n                    console.warn(`sendMessageStream() was unsuccessful. ${blockErrorMessage}. Inspect response object for details.`);\n                }\n            }\n        })\n            .catch((e) => {\n            // Errors in streamPromise are already catchable by the user as\n            // streamPromise is returned.\n            // Avoid duplicating the error message in logs.\n            if (e.message !== SILENT_ERROR) {\n                // Users do not have access to _sendPromise to catch errors\n                // downstream from streamPromise, so they should not throw.\n                console.error(e);\n            }\n        });\n        return streamPromise;\n    }\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nasync function countTokens(apiKey, model, params, singleRequestOptions) {\n    const response = await makeModelRequest(model, Task.COUNT_TOKENS, apiKey, false, JSON.stringify(params), singleRequestOptions);\n    return response.json();\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nasync function embedContent(apiKey, model, params, requestOptions) {\n    const response = await makeModelRequest(model, Task.EMBED_CONTENT, apiKey, false, JSON.stringify(params), requestOptions);\n    return response.json();\n}\nasync function batchEmbedContents(apiKey, model, params, requestOptions) {\n    const requestsWithModel = params.requests.map((request) => {\n        return Object.assign(Object.assign({}, request), { model });\n    });\n    const response = await makeModelRequest(model, Task.BATCH_EMBED_CONTENTS, apiKey, false, JSON.stringify({ requests: requestsWithModel }), requestOptions);\n    return response.json();\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * Class for generative model APIs.\n * @public\n */\nclass GenerativeModel {\n    constructor(apiKey, modelParams, _requestOptions = {}) {\n        this.apiKey = apiKey;\n        this._requestOptions = _requestOptions;\n        if (modelParams.model.includes(\"/\")) {\n            // Models may be named \"models/model-name\" or \"tunedModels/model-name\"\n            this.model = modelParams.model;\n        }\n        else {\n            // If path is not included, assume it's a non-tuned model.\n            this.model = `models/${modelParams.model}`;\n        }\n        this.generationConfig = modelParams.generationConfig || {};\n        this.safetySettings = modelParams.safetySettings || [];\n        this.tools = modelParams.tools;\n        this.toolConfig = modelParams.toolConfig;\n        this.systemInstruction = formatSystemInstruction(modelParams.systemInstruction);\n        this.cachedContent = modelParams.cachedContent;\n    }\n    /**\n     * Makes a single non-streaming call to the model\n     * and returns an object containing a single {@link GenerateContentResponse}.\n     *\n     * Fields set in the optional {@link SingleRequestOptions} parameter will\n     * take precedence over the {@link RequestOptions} values provided to\n     * {@link GoogleGenerativeAI.getGenerativeModel }.\n     */\n    async generateContent(request, requestOptions = {}) {\n        var _a;\n        const formattedParams = formatGenerateContentInput(request);\n        const generativeModelRequestOptions = Object.assign(Object.assign({}, this._requestOptions), requestOptions);\n        return generateContent(this.apiKey, this.model, Object.assign({ generationConfig: this.generationConfig, safetySettings: this.safetySettings, tools: this.tools, toolConfig: this.toolConfig, systemInstruction: this.systemInstruction, cachedContent: (_a = this.cachedContent) === null || _a === void 0 ? void 0 : _a.name }, formattedParams), generativeModelRequestOptions);\n    }\n    /**\n     * Makes a single streaming call to the model and returns an object\n     * containing an iterable stream that iterates over all chunks in the\n     * streaming response as well as a promise that returns the final\n     * aggregated response.\n     *\n     * Fields set in the optional {@link SingleRequestOptions} parameter will\n     * take precedence over the {@link RequestOptions} values provided to\n     * {@link GoogleGenerativeAI.getGenerativeModel }.\n     */\n    async generateContentStream(request, requestOptions = {}) {\n        var _a;\n        const formattedParams = formatGenerateContentInput(request);\n        const generativeModelRequestOptions = Object.assign(Object.assign({}, this._requestOptions), requestOptions);\n        return generateContentStream(this.apiKey, this.model, Object.assign({ generationConfig: this.generationConfig, safetySettings: this.safetySettings, tools: this.tools, toolConfig: this.toolConfig, systemInstruction: this.systemInstruction, cachedContent: (_a = this.cachedContent) === null || _a === void 0 ? void 0 : _a.name }, formattedParams), generativeModelRequestOptions);\n    }\n    /**\n     * Gets a new {@link ChatSession} instance which can be used for\n     * multi-turn chats.\n     */\n    startChat(startChatParams) {\n        var _a;\n        return new ChatSession(this.apiKey, this.model, Object.assign({ generationConfig: this.generationConfig, safetySettings: this.safetySettings, tools: this.tools, toolConfig: this.toolConfig, systemInstruction: this.systemInstruction, cachedContent: (_a = this.cachedContent) === null || _a === void 0 ? void 0 : _a.name }, startChatParams), this._requestOptions);\n    }\n    /**\n     * Counts the tokens in the provided request.\n     *\n     * Fields set in the optional {@link SingleRequestOptions} parameter will\n     * take precedence over the {@link RequestOptions} values provided to\n     * {@link GoogleGenerativeAI.getGenerativeModel }.\n     */\n    async countTokens(request, requestOptions = {}) {\n        const formattedParams = formatCountTokensInput(request, {\n            model: this.model,\n            generationConfig: this.generationConfig,\n            safetySettings: this.safetySettings,\n            tools: this.tools,\n            toolConfig: this.toolConfig,\n            systemInstruction: this.systemInstruction,\n            cachedContent: this.cachedContent,\n        });\n        const generativeModelRequestOptions = Object.assign(Object.assign({}, this._requestOptions), requestOptions);\n        return countTokens(this.apiKey, this.model, formattedParams, generativeModelRequestOptions);\n    }\n    /**\n     * Embeds the provided content.\n     *\n     * Fields set in the optional {@link SingleRequestOptions} parameter will\n     * take precedence over the {@link RequestOptions} values provided to\n     * {@link GoogleGenerativeAI.getGenerativeModel }.\n     */\n    async embedContent(request, requestOptions = {}) {\n        const formattedParams = formatEmbedContentInput(request);\n        const generativeModelRequestOptions = Object.assign(Object.assign({}, this._requestOptions), requestOptions);\n        return embedContent(this.apiKey, this.model, formattedParams, generativeModelRequestOptions);\n    }\n    /**\n     * Embeds an array of {@link EmbedContentRequest}s.\n     *\n     * Fields set in the optional {@link SingleRequestOptions} parameter will\n     * take precedence over the {@link RequestOptions} values provided to\n     * {@link GoogleGenerativeAI.getGenerativeModel }.\n     */\n    async batchEmbedContents(batchEmbedContentRequest, requestOptions = {}) {\n        const generativeModelRequestOptions = Object.assign(Object.assign({}, this._requestOptions), requestOptions);\n        return batchEmbedContents(this.apiKey, this.model, batchEmbedContentRequest, generativeModelRequestOptions);\n    }\n}\n\n/**\n * @license\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * Top-level class for this SDK\n * @public\n */\nclass GoogleGenerativeAI {\n    constructor(apiKey) {\n        this.apiKey = apiKey;\n    }\n    /**\n     * Gets a {@link GenerativeModel} instance for the provided model name.\n     */\n    getGenerativeModel(modelParams, requestOptions) {\n        if (!modelParams.model) {\n            throw new GoogleGenerativeAIError(`Must provide a model name. ` +\n                `Example: genai.getGenerativeModel({ model: 'my-model-name' })`);\n        }\n        return new GenerativeModel(this.apiKey, modelParams, requestOptions);\n    }\n    /**\n     * Creates a {@link GenerativeModel} instance from provided content cache.\n     */\n    getGenerativeModelFromCachedContent(cachedContent, modelParams, requestOptions) {\n        if (!cachedContent.name) {\n            throw new GoogleGenerativeAIRequestInputError(\"Cached content must contain a `name` field.\");\n        }\n        if (!cachedContent.model) {\n            throw new GoogleGenerativeAIRequestInputError(\"Cached content must contain a `model` field.\");\n        }\n        /**\n         * Not checking tools and toolConfig for now as it would require a deep\n         * equality comparison and isn't likely to be a common case.\n         */\n        const disallowedDuplicates = [\"model\", \"systemInstruction\"];\n        for (const key of disallowedDuplicates) {\n            if ((modelParams === null || modelParams === void 0 ? void 0 : modelParams[key]) &&\n                cachedContent[key] &&\n                (modelParams === null || modelParams === void 0 ? void 0 : modelParams[key]) !== cachedContent[key]) {\n                if (key === \"model\") {\n                    const modelParamsComp = modelParams.model.startsWith(\"models/\")\n                        ? modelParams.model.replace(\"models/\", \"\")\n                        : modelParams.model;\n                    const cachedContentComp = cachedContent.model.startsWith(\"models/\")\n                        ? cachedContent.model.replace(\"models/\", \"\")\n                        : cachedContent.model;\n                    if (modelParamsComp === cachedContentComp) {\n                        continue;\n                    }\n                }\n                throw new GoogleGenerativeAIRequestInputError(`Different value for \"${key}\" specified in modelParams` +\n                    ` (${modelParams[key]}) and cachedContent (${cachedContent[key]})`);\n            }\n        }\n        const modelParamsFromCache = Object.assign(Object.assign({}, modelParams), { model: cachedContent.model, tools: cachedContent.tools, toolConfig: cachedContent.toolConfig, systemInstruction: cachedContent.systemInstruction, cachedContent });\n        return new GenerativeModel(this.apiKey, modelParamsFromCache, requestOptions);\n    }\n}\n\nexport { BlockReason, ChatSession, DynamicRetrievalMode, ExecutableCodeLanguage, FinishReason, FunctionCallingMode, GenerativeModel, GoogleGenerativeAI, GoogleGenerativeAIAbortError, GoogleGenerativeAIError, GoogleGenerativeAIFetchError, GoogleGenerativeAIRequestInputError, GoogleGenerativeAIResponseError, HarmBlockThreshold, HarmCategory, HarmProbability, Outcome, POSSIBLE_ROLES, SchemaType, TaskType };\n//# sourceMappingURL=index.mjs.map\n","/**\r\n * AI Compose — Gemini Client Service\r\n *\r\n * Provides a typed interface to the Google Generative AI (Gemini) API\r\n * with configurable parameters, rate-limiting with exponential backoff,\r\n * and granular error handling.\r\n *\r\n * © Rizonetech (Pty) Ltd. — https://rizonesoft.com\r\n */\r\n\r\nimport { GoogleGenerativeAI, GenerativeModel, GenerationConfig } from '@google/generative-ai';\r\nimport { getSetting } from '../features/settings';\r\n\r\n// ---------------------------------------------------------------------------\r\n// Types\r\n// ---------------------------------------------------------------------------\r\n\r\n/** Configurable generation options passed to `generateText`. */\r\nexport interface GenerateOptions {\r\n  /** Controls randomness. Lower = more deterministic. Range: 0.0–2.0. Default: 1.0 */\r\n  temperature?: number;\r\n  /** Maximum number of tokens in the response. Default: 2048 */\r\n  maxOutputTokens?: number;\r\n  /** Nucleus sampling. Range: 0.0–1.0. Default: 0.95 */\r\n  topP?: number;\r\n  /** Top-K sampling. Default: 40 */\r\n  topK?: number;\r\n  /** Which Gemini model to use. Default: user's saved setting or 'gemini-2.5-flash' */\r\n  model?: string;\r\n}\r\n\r\n/** Error codes surfaced by the Gemini service. */\r\nexport enum GeminiErrorCode {\r\n  INVALID_API_KEY = 'INVALID_API_KEY',\r\n  QUOTA_EXCEEDED = 'QUOTA_EXCEEDED',\r\n  RATE_LIMITED = 'RATE_LIMITED',\r\n  NETWORK_ERROR = 'NETWORK_ERROR',\r\n  TIMEOUT = 'TIMEOUT',\r\n  CONTENT_FILTERED = 'CONTENT_FILTERED',\r\n  UNKNOWN = 'UNKNOWN',\r\n}\r\n\r\n/** Typed error thrown by the Gemini service. */\r\nexport class GeminiError extends Error {\r\n  code: GeminiErrorCode;\r\n  retryable: boolean;\r\n  statusCode?: number;\r\n\r\n  constructor(message: string, code: GeminiErrorCode, retryable = false, statusCode?: number) {\r\n    super(message);\r\n    this.name = 'GeminiError';\r\n    this.code = code;\r\n    this.retryable = retryable;\r\n    this.statusCode = statusCode;\r\n    // Fix prototype chain for ES5 targets (TypeScript class extending Error)\r\n    Object.setPrototypeOf(this, GeminiError.prototype);\r\n  }\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Constants\r\n// ---------------------------------------------------------------------------\r\n\r\nconst FALLBACK_MODEL = 'gemini-3-flash-preview';\r\nconst DEFAULT_TEMPERATURE = 1.0;\r\nconst DEFAULT_MAX_OUTPUT_TOKENS = 2048;\r\nconst DEFAULT_TOP_P = 0.95;\r\nconst DEFAULT_TOP_K = 40;\r\n\r\nconst MAX_RETRIES = 3;\r\nconst INITIAL_RETRY_DELAY_MS = 1000;\r\nconst RETRY_BACKOFF_FACTOR = 2;\r\nconst REQUEST_TIMEOUT_MS = 30_000;\r\n\r\n// ---------------------------------------------------------------------------\r\n// Client singleton\r\n// ---------------------------------------------------------------------------\r\n\r\nlet clientInstance: GoogleGenerativeAI | null = null;\r\n\r\n/**\r\n * Initialise (or reinitialise) the Gemini client with the given API key.\r\n * Returns the `GoogleGenerativeAI` instance for direct access if needed.\r\n */\r\nexport function initGeminiClient(apiKey: string): GoogleGenerativeAI {\r\n  if (!apiKey || apiKey.trim().length === 0) {\r\n    throw new GeminiError(\r\n      'API key is required. Please set GEMINI_API_KEY in your .env file.',\r\n      GeminiErrorCode.INVALID_API_KEY,\r\n    );\r\n  }\r\n  clientInstance = new GoogleGenerativeAI(apiKey);\r\n  return clientInstance;\r\n}\r\n\r\n/**\r\n * Returns the current client instance, or throws if `initGeminiClient`\r\n * has not been called yet.\r\n */\r\nfunction getClient(): GoogleGenerativeAI {\r\n  if (!clientInstance) {\r\n    throw new GeminiError(\r\n      'Gemini client not initialised. Call initGeminiClient(apiKey) first.',\r\n      GeminiErrorCode.INVALID_API_KEY,\r\n    );\r\n  }\r\n  return clientInstance;\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Core generation function\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Send a prompt to Gemini and return the generated text.\r\n *\r\n * @param prompt  - The user prompt string.\r\n * @param options - Optional generation parameters.\r\n * @returns The model's text response.\r\n *\r\n * @throws {GeminiError} with a typed `code` for every failure scenario.\r\n */\r\nexport async function generateText(\r\n  prompt: string,\r\n  options: GenerateOptions = {},\r\n): Promise<string> {\r\n  const client = getClient();\r\n  const modelName = options.model ?? getSetting('defaultModel') ?? FALLBACK_MODEL;\r\n\r\n  const generationConfig: GenerationConfig = {\r\n    temperature: options.temperature ?? DEFAULT_TEMPERATURE,\r\n    maxOutputTokens: options.maxOutputTokens ?? DEFAULT_MAX_OUTPUT_TOKENS,\r\n    topP: options.topP ?? DEFAULT_TOP_P,\r\n    topK: options.topK ?? DEFAULT_TOP_K,\r\n  };\r\n\r\n  const model: GenerativeModel = client.getGenerativeModel({\r\n    model: modelName,\r\n    generationConfig,\r\n  });\r\n\r\n  return retryWithBackoff(() => callModel(model, prompt));\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Internal helpers\r\n// ---------------------------------------------------------------------------\r\n\r\n/** Make a single API call with a timeout wrapper. */\r\nasync function callModel(model: GenerativeModel, prompt: string): Promise<string> {\r\n  try {\r\n    const result = await withTimeout(model.generateContent(prompt), REQUEST_TIMEOUT_MS);\r\n\r\n    const response = result.response;\r\n    const text = response.text();\r\n\r\n    if (!text || text.trim().length === 0) {\r\n      throw new GeminiError(\r\n        'The model returned an empty response. The content may have been filtered.',\r\n        GeminiErrorCode.CONTENT_FILTERED,\r\n      );\r\n    }\r\n\r\n    return text;\r\n  } catch (error) {\r\n    throw classifyError(error);\r\n  }\r\n}\r\n\r\n/** Wrap a promise with a timeout. */\r\nfunction withTimeout<T>(promise: Promise<T>, ms: number): Promise<T> {\r\n  return new Promise<T>((resolve, reject) => {\r\n    const timer = setTimeout(() => {\r\n      reject(\r\n        new GeminiError(\r\n          `Request timed out after ${ms / 1000}s. Check your network connection.`,\r\n          GeminiErrorCode.TIMEOUT,\r\n          true,\r\n        ),\r\n      );\r\n    }, ms);\r\n\r\n    promise\r\n      .then((value) => {\r\n        clearTimeout(timer);\r\n        resolve(value);\r\n      })\r\n      .catch((err) => {\r\n        clearTimeout(timer);\r\n        reject(err);\r\n      });\r\n  });\r\n}\r\n\r\n/**\r\n * Retry a function with exponential backoff.\r\n * Only retries errors marked as `retryable`.\r\n */\r\nasync function retryWithBackoff(fn: () => Promise<string>): Promise<string> {\r\n  let lastError: GeminiError | undefined;\r\n  let delay = INITIAL_RETRY_DELAY_MS;\r\n\r\n  for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {\r\n    try {\r\n      return await fn();\r\n    } catch (error) {\r\n      lastError = error instanceof GeminiError ? error : classifyError(error);\r\n\r\n      if (!lastError.retryable || attempt === MAX_RETRIES) {\r\n        throw lastError;\r\n      }\r\n\r\n      // Wait with jitter before retrying\r\n      const jitter = Math.random() * 0.3 * delay;\r\n      await sleep(delay + jitter);\r\n      delay *= RETRY_BACKOFF_FACTOR;\r\n    }\r\n  }\r\n\r\n  // Should never reach here, but TypeScript needs it\r\n  throw lastError!;\r\n}\r\n\r\n/** Classify raw errors into typed GeminiError instances. */\r\nfunction classifyError(error: unknown): GeminiError {\r\n  // Already classified\r\n  if (error instanceof GeminiError) {\r\n    return error;\r\n  }\r\n\r\n  const message = error instanceof Error ? error.message : String(error);\r\n  const statusCode = extractStatusCode(error);\r\n\r\n  // Invalid / expired API key\r\n  if (statusCode === 401 || statusCode === 403 || /api.?key/i.test(message)) {\r\n    return new GeminiError(\r\n      'Invalid or expired API key. Please check your GEMINI_API_KEY.',\r\n      GeminiErrorCode.INVALID_API_KEY,\r\n      false,\r\n      statusCode,\r\n    );\r\n  }\r\n\r\n  // Rate limited\r\n  if (statusCode === 429 || /rate.?limit/i.test(message) || /too many requests/i.test(message)) {\r\n    return new GeminiError(\r\n      'Rate limited by the Gemini API. Retrying with backoff…',\r\n      GeminiErrorCode.RATE_LIMITED,\r\n      true,\r\n      429,\r\n    );\r\n  }\r\n\r\n  // Quota exceeded\r\n  if (statusCode === 429 && /quota/i.test(message)) {\r\n    return new GeminiError(\r\n      'API quota exceeded. Check your billing and quota settings in the Google Cloud Console.',\r\n      GeminiErrorCode.QUOTA_EXCEEDED,\r\n      false,\r\n      429,\r\n    );\r\n  }\r\n\r\n  // Network errors\r\n  if (\r\n    /network/i.test(message) ||\r\n    /fetch failed/i.test(message) ||\r\n    /ECONNREFUSED/i.test(message) ||\r\n    /ENOTFOUND/i.test(message) ||\r\n    /offline/i.test(message)\r\n  ) {\r\n    return new GeminiError(\r\n      'Network error — please check your internet connection.',\r\n      GeminiErrorCode.NETWORK_ERROR,\r\n      true,\r\n    );\r\n  }\r\n\r\n  // Content safety filter\r\n  if (/safety/i.test(message) || /blocked/i.test(message) || /filter/i.test(message)) {\r\n    return new GeminiError(\r\n      'The response was blocked by content safety filters.',\r\n      GeminiErrorCode.CONTENT_FILTERED,\r\n      false,\r\n    );\r\n  }\r\n\r\n  // Server errors (5xx) are retryable\r\n  if (statusCode && statusCode >= 500) {\r\n    return new GeminiError(\r\n      `Server error (${statusCode}). Retrying…`,\r\n      GeminiErrorCode.UNKNOWN,\r\n      true,\r\n      statusCode,\r\n    );\r\n  }\r\n\r\n  // Unknown\r\n  return new GeminiError(\r\n    `Unexpected error: ${message}`,\r\n    GeminiErrorCode.UNKNOWN,\r\n    false,\r\n    statusCode,\r\n  );\r\n}\r\n\r\n/** Try to extract an HTTP status code from an error object. */\r\nfunction extractStatusCode(error: unknown): number | undefined {\r\n  if (error && typeof error === 'object') {\r\n    const obj = error as Record<string, unknown>;\r\n    if (typeof obj.status === 'number') return obj.status;\r\n    if (typeof obj.statusCode === 'number') return obj.statusCode;\r\n    if (typeof obj.code === 'number') return obj.code;\r\n    // Google AI SDK sometimes nests it\r\n    if (obj.response && typeof obj.response === 'object') {\r\n      const resp = obj.response as Record<string, unknown>;\r\n      if (typeof resp.status === 'number') return resp.status;\r\n    }\r\n  }\r\n  return undefined;\r\n}\r\n\r\n/** Promise-based sleep. */\r\nfunction sleep(ms: number): Promise<void> {\r\n  return new Promise((resolve) => setTimeout(resolve, ms));\r\n}\r\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","/**\r\n * AI Compose — Prompt Templates\r\n *\r\n * Reusable prompt templates for all AI Compose features.\r\n * Each template uses {{PLACEHOLDER}} syntax for variable substitution\r\n * via the `buildPrompt` function in builder.ts.\r\n *\r\n * © Rizonetech (Pty) Ltd. — https://rizonesoft.com\r\n */\r\n\r\n// ---------------------------------------------------------------------------\r\n// Draft Email\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Compose a new email from bullet points or brief instructions.\r\n *\r\n * Placeholders: {{INSTRUCTIONS}}, {{TONE}}, {{LANGUAGE}}\r\n */\r\nexport const DRAFT_EMAIL_PROMPT = `You are a professional email assistant.\r\n\r\nDraft a complete email based on the following instructions:\r\n\r\n{{INSTRUCTIONS}}\r\n\r\nRequirements:\r\n- Tone: {{TONE}}\r\n- Language: {{LANGUAGE}}\r\n- Include a subject line on the first line prefixed with \"Subject: \"\r\n- Use appropriate greeting and sign-off\r\n- Keep the email concise and to the point\r\n- Do not add any commentary outside the email itself`;\r\n\r\n// ---------------------------------------------------------------------------\r\n// Reply\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Generate a reply to an existing email.\r\n *\r\n * Placeholders: {{ORIGINAL_EMAIL}}, {{REPLY_INSTRUCTIONS}}, {{TONE}}\r\n */\r\nexport const REPLY_PROMPT = `You are a professional email assistant.\r\n\r\nHere is the original email you are replying to:\r\n\r\n---\r\n{{ORIGINAL_EMAIL}}\r\n---\r\n\r\nReply instructions: {{REPLY_INSTRUCTIONS}}\r\n\r\nRequirements:\r\n- Tone: {{TONE}}\r\n- Language: {{LANGUAGE}}\r\n- Address the reply to: {{REPLY_TO_NAME}} (this is the person you are replying to, NOT the person the original email was addressed to)\r\n- Write only the reply body (no subject line needed)\r\n- Reference relevant points from the original email naturally\r\n- Keep the reply focused and professional\r\n- Do not add any commentary outside the reply itself`;\r\n\r\n// ---------------------------------------------------------------------------\r\n// Summarize Thread\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Summarize a multi-message email thread.\r\n *\r\n * Placeholders: {{EMAIL_THREAD}}, {{SUMMARY_LENGTH}}\r\n */\r\nexport const SUMMARIZE_THREAD_PROMPT = `You are a professional email assistant.\r\n\r\nSummarize the following email thread:\r\n\r\n---\r\n{{EMAIL_THREAD}}\r\n---\r\n\r\nRequirements:\r\n- Length: {{SUMMARY_LENGTH}} (brief = 2-3 sentences, standard = 1 paragraph, detailed = multiple paragraphs)\r\n- Identify the key discussion points and decisions made\r\n- Note any action items or deadlines mentioned\r\n- List the participants and their main positions\r\n- Use bullet points for clarity where appropriate\r\n- Do not add opinions or information not present in the thread`;\r\n\r\n// ---------------------------------------------------------------------------\r\n// Improve Writing\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Improve grammar, clarity, and tone of selected text.\r\n *\r\n * Placeholders: {{TEXT}}, {{IMPROVEMENT_FOCUS}}\r\n */\r\nexport const IMPROVE_WRITING_PROMPT = `You are a professional writing assistant.\r\n\r\nImprove the following text:\r\n\r\n---\r\n{{TEXT}}\r\n---\r\n\r\nFocus on: {{IMPROVEMENT_FOCUS}}\r\n\r\nRequirements:\r\n- Fix grammar, spelling, and punctuation errors\r\n- Improve clarity and readability\r\n- Maintain the original meaning and intent\r\n- Keep the same general length unless brevity improves the text\r\n- Return only the improved text, no explanations or annotations`;\r\n\r\n// ---------------------------------------------------------------------------\r\n// Extract Action Items\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Pull tasks, deadlines, and responsibilities from emails.\r\n *\r\n * Placeholders: {{EMAIL_CONTENT}}\r\n */\r\nexport const EXTRACT_ACTION_ITEMS_PROMPT = `You are a professional email assistant.\r\n\r\nExtract all action items, tasks, and deadlines from the following email:\r\n\r\n---\r\n{{EMAIL_CONTENT}}\r\n---\r\n\r\nRequirements:\r\n- List each action item as a bullet point\r\n- For each item, identify:\r\n  - **Task**: What needs to be done\r\n  - **Owner**: Who is responsible (if mentioned)\r\n  - **Deadline**: When it's due (if mentioned)\r\n- If no action items are found, respond with \"No action items found.\"\r\n- Only extract items explicitly stated or clearly implied in the email\r\n- Do not invent tasks that are not present`;\r\n\r\n// ---------------------------------------------------------------------------\r\n// Translate\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Translate email content to a target language.\r\n *\r\n * Placeholders: {{TEXT}}, {{TARGET_LANGUAGE}}\r\n */\r\nexport const TRANSLATE_PROMPT = `You are a professional translator.\r\n\r\nTranslate the following text to {{TARGET_LANGUAGE}}:\r\n\r\n---\r\n{{TEXT}}\r\n---\r\n\r\nRequirements:\r\n- Maintain the original formatting (paragraphs, bullet points, etc.)\r\n- Preserve the original tone and register\r\n- Use natural, fluent phrasing in the target language (not literal word-for-word)\r\n- Keep proper nouns, brand names, and technical terms as-is unless they have\r\n  well-known translations\r\n- Return only the translated text, no explanations`;\r\n\r\n// ---------------------------------------------------------------------------\r\n// Change Tone\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Rewrite text in a different tone.\r\n *\r\n * Placeholders: {{TEXT}}, {{TARGET_TONE}}\r\n *\r\n * Supported tones: formal, casual, friendly, professional, assertive, empathetic\r\n */\r\nexport const CHANGE_TONE_PROMPT = `You are a professional writing assistant.\r\n\r\nRewrite the following text in a {{TARGET_TONE}} tone:\r\n\r\n---\r\n{{TEXT}}\r\n---\r\n\r\nRequirements:\r\n- Maintain the original meaning and all key information\r\n- Adjust vocabulary, sentence structure, and phrasing to match the target tone\r\n- Keep approximately the same length\r\n- Return only the rewritten text, no explanations or annotations`;\r\n","/**\n * AI Compose — Add-in Commands (Function Commands)\n *\n * Registers ExecuteFunction handlers for compose-mode ribbon buttons.\n * These run silently (no taskpane) on the user's selected text:\n *   - Fix Grammar & Spelling\n *   - Improve Clarity\n *   - Make Concise\n *   - Make Professional\n *\n * © Rizonetech (Pty) Ltd. — https://rizonesoft.com\n */\n\n/* global Office */\n\nimport { generateText } from '../services/gemini';\nimport { buildPrompt } from '../prompts/builder';\nimport { IMPROVE_WRITING_PROMPT } from '../prompts/templates';\n\n// ---------------------------------------------------------------------------\n// Types\n// ---------------------------------------------------------------------------\n\ntype ImprovementFocus =\n  | 'fix_grammar'\n  | 'improve_clarity'\n  | 'make_concise'\n  | 'make_professional';\n\nconst FOCUS_LABELS: Record<ImprovementFocus, string> = {\n  fix_grammar: 'Fix grammar, spelling, and punctuation errors',\n  improve_clarity: 'Improve clarity and readability',\n  make_concise: 'Make the text more concise — remove unnecessary words',\n  make_professional: 'Make the tone more professional and polished',\n};\n\n// ---------------------------------------------------------------------------\n// Core helper — improve selected text in-place\n// ---------------------------------------------------------------------------\n\n/**\n * Read the selected text in compose mode, send it to Gemini with the given\n * improvement focus, and replace the selection with the improved version.\n */\nasync function improveSelectedText(\n  focus: ImprovementFocus,\n  event: Office.AddinCommands.Event,\n): Promise<void> {\n  const item = Office.context.mailbox.item;\n\n  if (!item) {\n    showNotification('No email is open.', event);\n    return;\n  }\n\n  try {\n    // 1. Read the selected text\n    const selectedText = await getSelectedText(item);\n\n    if (!selectedText.trim()) {\n      showNotification('Please select some text first.', event);\n      return;\n    }\n\n    // 2. Build the prompt and call Gemini\n    const focusLabel = FOCUS_LABELS[focus];\n    const prompt = buildPrompt(IMPROVE_WRITING_PROMPT, {\n      TEXT: selectedText,\n      IMPROVEMENT_FOCUS: focusLabel,\n    });\n\n    const improved = await generateText(prompt, {\n      temperature: 0.3,\n      maxOutputTokens: 2048,\n    });\n\n    // 3. Replace the selected text with the improved version\n    await setSelectedText(item, improved);\n\n    showNotification('✓ Text improved', event);\n  } catch (err: any) {\n    const message = err?.message || 'Failed to improve text.';\n    showNotification(`Error: ${message}`, event);\n  }\n}\n\n// ---------------------------------------------------------------------------\n// Office.js helpers\n// ---------------------------------------------------------------------------\n\nfunction getSelectedText(item: any): Promise<string> {\n  return new Promise((resolve, reject) => {\n    if (typeof item.getSelectedDataAsync !== 'function') {\n      reject(new Error('Selection API not available. Ensure you are in compose mode.'));\n      return;\n    }\n\n    item.getSelectedDataAsync(\n      Office.CoercionType.Text,\n      (result: Office.AsyncResult<any>) => {\n        if (result.status === Office.AsyncResultStatus.Succeeded) {\n          resolve(result.value?.data || '');\n        } else {\n          reject(new Error(result.error?.message || 'Failed to read selected text'));\n        }\n      },\n    );\n  });\n}\n\nfunction setSelectedText(item: any, text: string): Promise<void> {\n  return new Promise((resolve, reject) => {\n    if (!item.body || typeof item.body.setSelectedDataAsync !== 'function') {\n      reject(new Error('Cannot write to compose body.'));\n      return;\n    }\n\n    item.body.setSelectedDataAsync(\n      text,\n      { coercionType: Office.CoercionType.Text },\n      (result: Office.AsyncResult<void>) => {\n        if (result.status === Office.AsyncResultStatus.Succeeded) {\n          resolve();\n        } else {\n          reject(new Error(result.error?.message || 'Failed to replace text'));\n        }\n      },\n    );\n  });\n}\n\nfunction showNotification(message: string, event: Office.AddinCommands.Event): void {\n  const item = Office.context.mailbox.item;\n\n  if (item) {\n    item.notificationMessages.replaceAsync('AIComposeNotification', {\n      type: Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,\n      message,\n      icon: 'Icon.16x16',\n      persistent: false,\n    } as Office.NotificationMessageDetails);\n  }\n\n  event.completed();\n}\n\n// ---------------------------------------------------------------------------\n// Function command handlers\n// ---------------------------------------------------------------------------\n\nfunction fixGrammar(event: Office.AddinCommands.Event): void {\n  improveSelectedText('fix_grammar', event);\n}\n\nfunction improveClarity(event: Office.AddinCommands.Event): void {\n  improveSelectedText('improve_clarity', event);\n}\n\nfunction makeConcise(event: Office.AddinCommands.Event): void {\n  improveSelectedText('make_concise', event);\n}\n\nfunction makeProfessional(event: Office.AddinCommands.Event): void {\n  improveSelectedText('make_professional', event);\n}\n\n// ---------------------------------------------------------------------------\n// Initialization\n// ---------------------------------------------------------------------------\n\nOffice.onReady(() => {\n  // Register all function commands with Office\n  Office.actions.associate('fixGrammar', fixGrammar);\n  Office.actions.associate('improveClarity', improveClarity);\n  Office.actions.associate('makeConcise', makeConcise);\n  Office.actions.associate('makeProfessional', makeProfessional);\n});\n","/**\r\n * AI Compose — Prompt Builder\r\n *\r\n * Utilities for constructing prompts from templates with variable\r\n * substitution and safe context truncation.\r\n *\r\n * © Rizonetech (Pty) Ltd. — https://rizonesoft.com\r\n */\r\n\r\n// ---------------------------------------------------------------------------\r\n// Types\r\n// ---------------------------------------------------------------------------\r\n\r\n/** A record of placeholder names (without braces) to their values. */\r\nexport type PromptVariables = Record<string, string>;\r\n\r\n// ---------------------------------------------------------------------------\r\n// Constants\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Rough estimate: 1 token ≈ 4 characters for English text.\r\n * This is a conservative approximation used for truncation.\r\n */\r\nconst CHARS_PER_TOKEN = 4;\r\n\r\n/** Suffix appended when text is truncated. */\r\nconst TRUNCATION_SUFFIX = '\\n\\n[Content truncated due to length…]';\r\n\r\n// ---------------------------------------------------------------------------\r\n// Public API\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Replace `{{PLACEHOLDER}}` markers in a template with the provided values.\r\n *\r\n * - Placeholders are case-sensitive and matched exactly.\r\n * - Missing variables are left as-is (e.g. `{{UNKNOWN}}` stays in the output).\r\n * - Extra variables not present in the template are silently ignored.\r\n *\r\n * @param template  - The prompt template string with `{{VAR}}` placeholders.\r\n * @param variables - A key-value map of placeholder names to replacement values.\r\n * @returns The fully interpolated prompt string.\r\n *\r\n * @example\r\n * ```ts\r\n * buildPrompt('Hello {{NAME}}, your order {{ID}} is ready.', {\r\n *   NAME: 'Alice',\r\n *   ID: '12345',\r\n * });\r\n * // → 'Hello Alice, your order 12345 is ready.'\r\n * ```\r\n */\r\nexport function buildPrompt(template: string, variables: PromptVariables, appendRules = false): string {\r\n  if (!template) {\r\n    throw new Error('Prompt template cannot be empty.');\r\n  }\r\n\r\n  let result = template;\r\n\r\n  for (const [key, value] of Object.entries(variables)) {\r\n    const placeholder = `{{${key}}}`;\r\n    result = result.split(placeholder).join(value);\r\n  }\r\n\r\n  // Append user-defined rules only for composition features (draft/reply)\r\n  if (appendRules) {\r\n    try {\r\n      const { buildRulesText } = require('../features/settings');\r\n      result += buildRulesText();\r\n    } catch {\r\n      // Settings module not available — skip rules injection\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Safely truncate text to fit within an approximate token budget.\r\n *\r\n * Truncation is performed at sentence boundaries when possible to avoid\r\n * cutting mid-sentence. A suffix is appended to indicate that content\r\n * was removed.\r\n *\r\n * @param text      - The text to truncate.\r\n * @param maxTokens - The maximum number of tokens allowed.\r\n * @returns The (possibly truncated) text.\r\n *\r\n * @example\r\n * ```ts\r\n * truncateContext('A very long email body...', 500);\r\n * // → First ~2000 chars, ending at a sentence boundary + truncation notice\r\n * ```\r\n */\r\nexport function truncateContext(text: string, maxTokens: number): string {\r\n  if (!text) return text;\r\n  if (maxTokens <= 0) {\r\n    throw new Error('maxTokens must be a positive number.');\r\n  }\r\n\r\n  const maxChars = maxTokens * CHARS_PER_TOKEN;\r\n\r\n  // No truncation needed\r\n  if (text.length <= maxChars) {\r\n    return text;\r\n  }\r\n\r\n  // Reserve space for the truncation suffix\r\n  const availableChars = maxChars - TRUNCATION_SUFFIX.length;\r\n\r\n  if (availableChars <= 0) {\r\n    return TRUNCATION_SUFFIX.trim();\r\n  }\r\n\r\n  // Try to truncate at a sentence boundary\r\n  const slice = text.slice(0, availableChars);\r\n  const lastSentenceEnd = findLastSentenceBoundary(slice);\r\n\r\n  const truncated = lastSentenceEnd > 0 ? slice.slice(0, lastSentenceEnd) : slice;\r\n\r\n  return truncated.trimEnd() + TRUNCATION_SUFFIX;\r\n}\r\n\r\n/**\r\n * List all placeholder names found in a template.\r\n *\r\n * @param template - The prompt template string.\r\n * @returns An array of unique placeholder names (without braces).\r\n *\r\n * @example\r\n * ```ts\r\n * listPlaceholders('Hello {{NAME}}, your {{ITEM}} is {{STATUS}}.');\r\n * // → ['NAME', 'ITEM', 'STATUS']\r\n * ```\r\n */\r\nexport function listPlaceholders(template: string): string[] {\r\n  const matches = template.match(/\\{\\{([A-Z_][A-Z0-9_]*)\\}\\}/g);\r\n  if (!matches) return [];\r\n\r\n  const names = matches.map((m) => m.slice(2, -2));\r\n  return Array.from(new Set(names));\r\n}\r\n\r\n// ---------------------------------------------------------------------------\r\n// Internal helpers\r\n// ---------------------------------------------------------------------------\r\n\r\n/**\r\n * Find the index just after the last sentence-ending punctuation\r\n * (., !, or ?) in the given text.\r\n * Returns -1 if no sentence boundary is found.\r\n */\r\nfunction findLastSentenceBoundary(text: string): number {\r\n  // Match period, exclamation, or question mark followed by space or end-of-string\r\n  for (let i = text.length - 1; i >= 0; i--) {\r\n    const char = text[i];\r\n    if (char === '.' || char === '!' || char === '?') {\r\n      return i + 1;\r\n    }\r\n  }\r\n  return -1;\r\n}\r\n"],"names":["STORAGE_KEY","LEGACY_STORAGE_KEY","DEFAULT_SETTINGS","apiKey","defaultModel","defaultTone","defaultSummaryStyle","defaultLanguage","presetRules","noPlaceholders","noSubjectLine","keepShort","useSimpleLanguage","customRules","cached","loadSettings","raw","localStorage","getItem","legacy","setItem","removeItem","parsed","JSON","parse","saveSettings","settings","previousKey","stringify","initGeminiClient","getApiKey","setApiKey","key","getSetting","resetSettings","PRESET_RULE_LABELS","buildRulesText","lines","enabled","Object","entries","push","trim","length","join","SchemaType","ExecutableCodeLanguage","Outcome","POSSIBLE_ROLES","HarmCategory","HarmBlockThreshold","HarmProbability","BlockReason","FinishReason","TaskType","FunctionCallingMode","DynamicRetrievalMode","Task","GoogleGenerativeAIError","Error","constructor","message","super","GoogleGenerativeAIResponseError","response","this","GoogleGenerativeAIFetchError","status","statusText","errorDetails","GoogleGenerativeAIRequestInputError","GoogleGenerativeAIAbortError","RequestUrl","model","task","stream","requestOptions","toString","_a","_b","apiVersion","url","baseUrl","async","getHeaders","headers","Headers","append","clientHeaders","apiClient","getClientHeaders","customHeaders","e","headerName","headerValue","makeModelRequest","body","fetchFn","fetch","fetchOptions","assign","buildFetchOptions","method","constructModelRequest","err","name","stack","handleResponseError","ok","json","error","details","handleResponseNotOk","makeRequest","undefined","signal","timeout","controller","AbortController","setTimeout","abort","addEventListener","addHelpers","text","candidates","console","warn","hadBadFinishReason","formatBlockErrorMessage","_c","_d","textStrings","content","parts","part","executableCode","language","code","codeExecutionResult","output","getText","promptFeedback","functionCall","getFunctionCalls","functionCalls","badFinishReasons","RECITATION","SAFETY","LANGUAGE","candidate","finishReason","includes","firstCandidate","finishMessage","blockReason","blockReasonMessage","__await","v","SuppressedError","responseLineRE","getResponsePromise","allResponses","reader","getReader","done","value","read","aggregateResponses","generateResponseSequence","thisArg","_arguments","generator","Symbol","asyncIterator","TypeError","i","g","apply","q","verb","n","Promise","a","b","resume","r","resolve","then","fulfill","reject","settle","f","shift","__asyncGenerator","arguments","responses","lastResponse","aggregatedResponse","candidateIndex","index","citationMetadata","groundingMetadata","safetyRatings","role","newPart","keys","usageMetadata","generateContentStream","params","responseStream","inputStream","ReadableStream","start","currentText","pump","close","parsedResponse","match","enqueue","substring","catch","getResponseStream","pipeThrough","TextDecoderStream","fatal","stream1","stream2","tee","processStream","STREAM_GENERATE_CONTENT","generateContent","GENERATE_CONTENT","formatSystemInstruction","input","formatNewContent","request","newParts","partOrString","userContent","functionContent","hasUserContent","hasFunctionContent","assignRoleToPartsAndValidateSendMessageRequest","formatGenerateContentInput","formattedRequest","contents","systemInstruction","VALID_PART_FIELDS","VALID_PARTS_PER_ROLE","user","function","system","isValidResponse","SILENT_ERROR","ChatSession","_requestOptions","_history","_sendPromise","_apiKey","history","prevContent","currContent","Array","isArray","countFields","inlineData","functionResponse","fileData","validParts","validateChatHistory","getHistory","sendMessage","_e","_f","newContent","generateContentRequest","safetySettings","generationConfig","tools","toolConfig","cachedContent","chatSessionRequestOptions","finalResult","result","responseContent","blockErrorMessage","sendMessageStream","streamPromise","_ignored","streamResult","GenerativeModel","modelParams","formattedParams","generativeModelRequestOptions","startChat","startChatParams","countTokens","formattedGenerateContentRequest","containsGenerateContentRequest","formatCountTokensInput","singleRequestOptions","COUNT_TOKENS","embedContent","EMBED_CONTENT","batchEmbedContents","batchEmbedContentRequest","requestsWithModel","requests","map","BATCH_EMBED_CONTENTS","GoogleGenerativeAI","getGenerativeModel","getGenerativeModelFromCachedContent","disallowedDuplicates","startsWith","replace","modelParamsFromCache","GeminiErrorCode","GeminiError","retryable","statusCode","setPrototypeOf","prototype","clientInstance","INVALID_API_KEY","generateText","prompt","options","client","getClient","modelName","temperature","maxOutputTokens","topP","topK","fn","lastError","delay","attempt","classifyError","jitter","Math","random","sleep","retryWithBackoff","promise","timer","TIMEOUT","clearTimeout","CONTENT_FILTERED","callModel","String","obj","resp","extractStatusCode","test","RATE_LIMITED","QUOTA_EXCEEDED","NETWORK_ERROR","UNKNOWN","ms","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","exports","module","__webpack_modules__","d","definition","o","defineProperty","enumerable","get","prop","hasOwnProperty","call","toStringTag","FOCUS_LABELS","fix_grammar","improve_clarity","make_concise","make_professional","improveSelectedText","focus","event","item","Office","context","mailbox","selectedText","getSelectedDataAsync","CoercionType","Text","AsyncResultStatus","Succeeded","data","getSelectedText","showNotification","template","variables","appendRules","placeholder","split","require","buildPrompt","TEXT","IMPROVEMENT_FOCUS","improved","setSelectedDataAsync","coercionType","setSelectedText","notificationMessages","replaceAsync","type","MailboxEnums","ItemNotificationMessageType","InformationalMessage","icon","persistent","completed","fixGrammar","improveClarity","makeConcise","makeProfessional","onReady","actions","associate"],"sourceRoot":""}